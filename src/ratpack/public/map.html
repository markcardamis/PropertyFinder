
<!DOCTYPE html>
<html>
  <head>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 95%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div id="buttons">
    	<select id="type" onchange="filterMarkers(this.value);">
            <option value="">Please select category</option>
            <option value="Shortlisted">Shortlisted</option>
            <option value="R1">R1</option>
            <option value="R3">R3</option>
            <option value="R4">R4</option>
        </select>
    </div>


<script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-database.js"></script>



<script>
/**
 * Firebase config block.
 */
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyB1dkqYZ6NtVwfgQTW8GjL-N0M6jUJJPwM",
    authDomain: "propertyfinder-d2752.firebaseapp.com",
    databaseURL: "https://propertyfinder-d2752.firebaseio.com",
    projectId: "propertyfinder-d2752",
    storageBucket: "propertyfinder-d2752.appspot.com",
    messagingSenderId: "254562778288",
    appId: "1:254562778288:web:a83e899df53411a4"
  };
   var map;
   var marker;
   var markersArray = [];
   var propertiesArray = [];
   var infoWindow;
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  function initAuthentication(onAuthSuccess) {

      firebase.auth().onAuthStateChanged(function(user) {
        // [START_EXCLUDE silent]
        if (user) {
          // User is signed in.
          var email = user.email;
          var uid = user.uid;
          initFirebase();
        } else {
          // User is signed out.
          window.location = 'index.html';
        }

      });
    }
    window.onload = function() {
      initAuthentication();
    };

  function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -33.7278481, lng: 150.453873},
          zoom: 11,
          styles: [{
            featureType: 'poi',
            stylers: [{ visibility: 'off' }]  // Turn off POI.
          },
          {
            featureType: 'transit.station',
            stylers: [{ visibility: 'off' }]  // Turn off bus, train stations etc.
          }],
          disableDoubleClickZoom: true,
          streetViewControl: false,
        });

      }


      function initFirebase() {

        // Reference to the properties in Firebase.
        var clicks = firebase.database().ref('propertyListings');
        
        // Listen for clicks and add them to the heatmap.
        clicks.on('child_added',
          function(snapshot) {
            var newPosition = snapshot.val();
            var point = new google.maps.LatLng(newPosition.lat, newPosition.lng);
            var iconVar = (typeof newPosition.selectionReason === 'undefined')? { 
              	url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
              	}  : null ;
            marker = new google.maps.Marker({
              position: point,
              map: map,
              icon: iconVar
            });

            markersArray.push(marker);
            propertiesArray.push(newPosition);

            marker['infowindow'] = new google.maps.InfoWindow({
            maxWidth: 400,
            content: "<b>Price: </b>" + newPosition.price + '<br>' +
                        "<b>Zone: </b>" + newPosition.zone + '<br>' +
                        "<b>FSR: </b>" + newPosition.fsr + '<br>' +
                        "<b>Area: </b>" + newPosition.area + '<br>' +
                        "<b>Domain Listed Address: </b>" + newPosition.address + '<br>' +
                        "<b>Planning Portal Address: </b>" + newPosition.planningPortalAddress + '<br>' +
                        "<b>URL: </b>" + "<a href=" + newPosition.listingURL + ">" + newPosition.listingURL + "</a>" + '<br>' +
                        "<b>Selection Reason: </b>" + newPosition.selectionReason + '<br>' +
                        "<b>Summary: </b>" + newPosition.summaryDescription

            });

            google.maps.event.addListener(marker, 'click', function() {
              hideAllInfoWindows(map);
              this['infowindow'].open(map, this);
            });
          }
        );
      }

      function hideAllInfoWindows(map) {
   			markersArray.forEach(function(marker) {
     		marker.infowindow.close(map, marker);
  			}); 
		}


		/**
         * Function to filter markers by category
         */

        filterMarkers = function (category) {
            for (i = 0; i < markersArray.length; i++) {
                marker = markersArray[i];
                var property = propertiesArray[i];
                // If is same category or category not picked
                if (property.zone == category || category.length === 0 ||
                    (property.selectionReason && category == 'Shortlisted')) {
                    marker.setVisible(true);
                }
                    // Categories don't match 
                else {
                    marker.setVisible(false);
                }
            }
        }


    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRk9mLgyRjj5dY89K0LRrKrxFbyFoS4nM&libraries=visualization&callback=initMap">
    </script>
  </body>
</html>